<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>⭐ Avg Rating by Version</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    .navbar { padding: 10px; border-bottom: 1px solid #ccc; text-align: center; }
    .navbar a { margin: 0 10px; text-decoration: none; color: #007bff; }
    .navbar a:hover { text-decoration: underline; }
    #controls { margin: 15px 0; text-align: center; }
    label { margin: 0 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="navbar">
	<a href="index.html">🏠 Home</a>
    <a href="home.html">🌍 Topic Clusters</a>
    <a href="overview.html">📈 Topics Overview</a>
    <a href="sentiment.html">📈 Sentiments</a>
    <a href="review_trend.html">📈 Review Trends</a>
    <a href="rating_distribution.html">📊 Rating Distribution</a>
    <a href="avg_rating.html">⭐ Avg Rating by Version</a>

  </div>

   <h2>⭐ Average Rating by App Version</h2>
  <div id="controls">
    <label>App Version:</label>
    <select id="avgVersionFilter" multiple></select>
    <label>Start Date:</label>
    <input type="date" id="avgDateStart">
    <label>End Date:</label>
    <input type="date" id="avgDateEnd">
    <button onclick="drawAvg()">Apply</button>
  </div>
  <div id="avgPlot"></div>

  <script>
    let data = [];

    fetch("df_ytd.json")
      .then(resp => resp.json())
      .then(json => {
        data = json.map(d => ({
          review_date: new Date(d.review_date),
          rating: +d.rating,
          appVersion: d.appVersion || "Unknown"
        }));

        const versions = [...new Set(data.map(d => d.appVersion))].sort();
        const sel = document.getElementById("avgVersionFilter");
        const allOpt = document.createElement("option");
        allOpt.value = "__ALL__"; allOpt.textContent = "All Versions"; allOpt.selected = true;
        sel.appendChild(allOpt);
        versions.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v; opt.textContent = v; sel.appendChild(opt);
        });

        drawAvg();
      });

    function drawAvg() {
      let selected = Array.from(document.getElementById("avgVersionFilter").selectedOptions).map(o => o.value);
      if (selected.includes("__ALL__")) selected = [];
      const start = document.getElementById("avgDateStart").value ? new Date(document.getElementById("avgDateStart").value) : null;
      const end = document.getElementById("avgDateEnd").value ? new Date(document.getElementById("avgDateEnd").value) : null;

      let filtered = data;
      if (selected.length) filtered = filtered.filter(d => selected.includes(d.appVersion));
      if (start) filtered = filtered.filter(d => d.review_date >= start);
      if (end) filtered = filtered.filter(d => d.review_date <= end);

      let grouped = {};
      filtered.forEach(d => {
        if (!grouped[d.appVersion]) grouped[d.appVersion] = {count:0,sum:0};
        grouped[d.appVersion].count++; grouped[d.appVersion].sum += d.rating;
      });

      const avg = Object.entries(grouped).map(([v,obj]) => ({ version:v, rating:obj.sum/obj.count }));
      avg.sort((a,b) => a.version.localeCompare(b.version));

      Plotly.newPlot("avgPlot", [{
        x: avg.map(a => a.version),
        y: avg.map(a => a.rating),
        type: "bar",
        text: avg.map(a => `Version: ${a.version}<br>Avg Rating: ${a.rating.toFixed(2)}`),
        hoverinfo: "text"
      }], {
        title:"Avg Rating by Version",
		xaxis:{title: "App Version"},
        yaxis:{title:"Avg Rating", range:[0,5]}
      });
    }
  </script>
</body>

</html>



