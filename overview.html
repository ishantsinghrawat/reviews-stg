<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .toolbar { display:flex; align-items:center; gap:10px; margin: 8px 0 12px; flex-wrap: wrap; }
    select { min-width: 240px; padding: 6px; }
    button { padding:8px 12px; border:0; border-radius:8px; background:#f2f3f5; cursor:pointer; }
    button:hover { background:#e8e9ec; }
    a.btn { padding:8px 12px; border-radius:8px; background:#1f75fe; color:white; text-decoration:none; font-weight:600; }
    a.btn:hover { opacity:.9; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 6px 8px; border-top: 1px solid #eee; vertical-align: top; }
    th { text-align: left; }
    td.center, th.center { text-align: center; }
    #hint { color:#666; font-style: italic; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f5f5f7; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar" style="margin-bottom:10px;">
    <a href="index.html">üè† Home</a>
    <a href="home.html">üåç Topic Clusters</a>
    <a href="overview.html"><b>‚úç Topics Overview</b></a>
    <a href="sentiment.html">üôÇ Sentiments</a>
    <a href="review_trend.html">üìà Review Trends</a>
    <a href="rating_distribution.html">üìä Rating Distribution</a>
    <a href="avg_rating.html">‚≠ê Avg Rating by Version</a>
  </div>

  <h1>Overview</h1>

  <!-- Filters toolbar -->
  <div class="toolbar">
    <label for="storeSelect"><strong>Source</strong></label>
    <select id="storeSelect"></select>

    <label for="versionSelect"><strong>Version</strong></label>
    <select id="versionSelect"></select>

    <label for="categorySelect"><strong>Category</strong></label>
    <select id="categorySelect" multiple></select>

    <button id="resetBtn">Reset</button>
    <a id="downloadLink" class="btn" download="reviews_overview.csv" href="#">Download Reviews</a>
  </div>

  <div id="summary" style="margin:8px 0 16px; color:#333;"></div>

  <div id="chart" style="height:420px;"></div>
  <h3>Reviews</h3>
  <div id="hint">Tip: Click a bar (category + sentiment) to view only those reviews. Click again to clear.</div>
  <div id="table"></div>

<script>
const DATA_URL = 'data.json';

let RAW = [];
let clickedCat = null;        // category chosen by clicking chart
let clickedSent = null;       // sentiment chosen by clicking trace
let selectedGroups = [];      // categories chosen via multi-select
let CAT_ORDER = [];           // sorted category list

const SENTI_MAP = { 'negative':'Negative','NEGATIVE':'Negative','LABEL_0':'Negative',
                    'neutral':'Neutral','NEUTRAL':'Neutral','LABEL_1':'Neutral',
                    'positive':'Positive','POSITIVE':'Positive','LABEL_2':'Positive' };

const fmtDate = s => !s ? '' : (s.length > 10 ? s.slice(0,10) : s);
const uniq = arr => Array.from(new Set(arr));

/* ---------- CSV download (includes Store & Version) ---------- */
function toCSVURI(rows) {
  if (!rows.length) return 'data:text/csv;charset=utf-8,';
  const cols = ['review','category','sentiment_std','rating','review_date','source','app_version'];
  const header = cols.join(',');
  const body = rows.map(r =>
    cols.map(c => {
      let v = r[c] ?? '';
      v = String(v).replace(/"/g, '""');
      if (/[",\n]/.test(v)) v = `"${v}"`;
      return v;
    }).join(',')
  ).join('\n');
  return 'data:text/csv;charset=utf-8,' + [header, body].join('\n');
}

/* ---------- Table render (shows Store & Version) ---------- */
function renderTable(rows, maxRows=1000) {
  const tbl = document.getElementById('table');
  const hint = document.getElementById('hint');
  if (!rows.length) {
    tbl.innerHTML = '';
    hint.textContent = (clickedCat || selectedGroups.length)
      ? 'No reviews match the current selection.'
      : 'Tip: Click a bar (category + sentiment) to view only those reviews.';
    return;
  }
  hint.textContent = '';
  const slice = rows.slice(0, maxRows);
  let html = `<table>
    <thead><tr>
      <th>Review</th>
      <th class="center">Sentiment</th>
      <th class="center">Rating</th>
      <th class="center">Date</th>
      <th class="center">Source</th>
      <th class="center">Version</th>
    </tr></thead><tbody>`;
  for (const r of slice) {
    html += `<tr>
      <td>${(r.review ?? '').replace(/</g,'&lt;')}</td>
      <td class="center">${r.sentiment_std ?? ''}</td>
      <td class="center">${r.rating ?? ''}</td>
      <td class="center">${fmtDate(r.review_date ?? '')}</td>
      <td class="center">${r.source || 'Unknown'}</td>
      <td class="center">${r.app_version || 'Unknown'}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  tbl.innerHTML = html;
}

/* ---------- Filters ---------- */
function getSelectedStore() {
  return document.getElementById('storeSelect').value || '';
}
function getSelectedVersion() {
  return document.getElementById('versionSelect').value || '';
}

/* Current filtered set (store + version + category; click (cat+sent) wins) */
function filteredRows() {
  let arr = RAW;

  const store = getSelectedStore();
  if (store) arr = arr.filter(r => (r.source || 'Unknown') === store);

  const version = getSelectedVersion();
  if (version) arr = arr.filter(r => String(r.app_version || 'Unknown') === version);

  if (clickedCat && clickedSent) {
    arr = arr.filter(r =>
      r.category === clickedCat &&
      (SENTI_MAP[r.sentiment_std] || r.sentiment_std) === clickedSent
    );
  } else if (clickedCat) {
    arr = arr.filter(r => r.category === clickedCat);
  } else if (selectedGroups.length) {
    const set = new Set(selectedGroups);
    arr = arr.filter(r => set.has(r.category));
  }
  return arr;
}

/* ---------- Chart highlight/dim logic ---------- */
function applyHighlight() {
  const chart = document.getElementById('chart');
  const sentiments = ['Positive','Neutral','Negative'];

  // Build per-trace opacity arrays
  const baseDim = 0.15;
  const full = 1.0;

  const opacities = sentiments.map(sent => {
    // one opacity value per category (x)
    return CAT_ORDER.map(cat => {
      if (!clickedCat && !clickedSent) return 1.0; // no dimming
      // If both cat+sent selected, only that single bar is full
      if (clickedCat && clickedSent) {
        return (cat === clickedCat && sent === clickedSent) ? full : baseDim;
      }
      // If only category selected (shouldn't happen now, but safe)
      if (clickedCat && !clickedSent) {
        return (cat === clickedCat) ? full : baseDim;
      }
      // Default
      return baseDim;
    });
  });

  // Apply with restyle
  Plotly.restyle(chart, { 'marker.opacity': [opacities[0], opacities[1], opacities[2]] });
}

/* ---------- Draw chart: grouped bars by sentiment ---------- */
function drawChart() {
  const rows = filteredRows();                     // chart respects filters
  CAT_ORDER = uniq(rows.map(r => r.category).filter(Boolean)).sort();

  // Build counts per (category, sentiment)
  const sentiments = ['Positive','Neutral','Negative'];
  const buckets = new Map(); // key: category|sentiment -> count
  for (const r of rows) {
    const c = r.category || '';
    const sRaw = r.sentiment_std || r.sentiment || '';
    const s = SENTI_MAP[sRaw] || sRaw;
    if (!c || !s) continue;
    const key = c + '|' + s;
    buckets.set(key, (buckets.get(key) || 0) + 1);
  }

  // y arrays per sentiment in CAT_ORDER
  const yPos = CAT_ORDER.map(c => buckets.get(c+'|Positive') || 0);
  const yNeu = CAT_ORDER.map(c => buckets.get(c+'|Neutral')  || 0);
  const yNeg = CAT_ORDER.map(c => buckets.get(c+'|Negative') || 0);

  const traces = [
    { name:'Positive', x: CAT_ORDER, y: yPos, type:'bar', marker:{ color:'#2ca02c' }, hovertemplate:'Category=%{x}<br>Positive=%{y}<extra></extra>' },
    { name:'Neutral',  x: CAT_ORDER, y: yNeu, type:'bar', marker:{ color:'#7f7f7f' }, hovertemplate:'Category=%{x}<br>Neutral=%{y}<extra></extra>' },
    { name:'Negative', x: CAT_ORDER, y: yNeg, type:'bar', marker:{ color:'#d62728' }, hovertemplate:'Category=%{x}<br>Negative=%{y}<extra></extra>' },
  ];

  const layout = {
    title: 'Reviews by Category & Sentiment',
    barmode: 'group',
    margin: {l:40,r:10,t:50,b:80},
    xaxis: { title: "Review Category" },
    yaxis: { title: "Count of Reviews" },
    legend: { orientation:'h', x:0, y:1.14 }
  };

  Plotly.newPlot('chart', traces, layout, {displayModeBar:false}).then(() => {
    applyHighlight();
  });

  // clicking any bar selects that category + sentiment
  const chart = document.getElementById('chart');
  chart.on('plotly_click', ev => {
    const pt = ev.points?.[0];
    if (!pt) return;
    const cat = pt.x;
    const sent = pt.data?.name; // 'Positive' | 'Neutral' | 'Negative'
    // Toggle if same bar clicked again
    if (clickedCat === cat && clickedSent === sent) {
      clickedCat = null;
      clickedSent = null;
    } else {
      clickedCat = cat;
      clickedSent = sent;
    }
    refreshViews();
  });
}

/* ---------- Populate selects ---------- */
function fillCategorySelect() {
  const sel = document.getElementById('categorySelect');
  const cats = uniq(RAW.map(r => r.category).filter(Boolean)).sort();
  sel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
  sel.addEventListener('change', () => {
    selectedGroups = Array.from(sel.selectedOptions).map(o => o.value);
    // Clear any click highlight if user uses the multi-select
    clickedCat = null;
    clickedSent = null;
    refreshViews();
  });
}

function fillStoreSelect() {
  const sel = document.getElementById('storeSelect');
  const stores = ['iOS & Android', ...uniq(RAW.map(r => r.source || 'Unknown')).sort()];
  sel.innerHTML = stores.map((s, i) =>
    `<option value="${i===0 ? '' : s}">${s}</option>`
  ).join('');
  sel.addEventListener('change', () => {
    fillVersionSelect();
    clickedCat = null;
    clickedSent = null;
    refreshViews();
  });
}

function fillVersionSelect() {
  const sel = document.getElementById('versionSelect');
  const store = getSelectedStore();
  const scope = store ? RAW.filter(r => (r.source || 'Unknown') === store) : RAW;
  const versions = ['All Versions', ...uniq(scope.map(r => String(r.app_version || 'Unknown'))).sort()];
  const current = sel.value;
  sel.innerHTML = versions.map((v, i) =>
    `<option value="${i===0 ? '' : v}">${v}</option>`
  ).join('');
  if (versions.includes(current)) sel.value = current;
  sel.addEventListener('change', () => {
    clickedCat = null;
    clickedSent = null;
    refreshViews();
  }, { once: true });
}

/* ---------- Reset ---------- */
document.getElementById('resetBtn').addEventListener('click', () => {
  clickedCat = null;
  clickedSent = null;
  selectedGroups = [];
  document.getElementById('categorySelect').selectedIndex = -1;
  document.getElementById('storeSelect').value = '';
  fillVersionSelect();
  document.getElementById('versionSelect').value = '';
  refreshViews(true);
});

/* ---------- Sync UI ---------- */
function refreshViews(resetTableHint=false) {
  drawChart();
  const view = filteredRows();
  renderTable(view);
  document.getElementById('downloadLink').href = toCSVURI(view.length ? view : RAW);
  if (resetTableHint && !view.length) {
    document.getElementById('hint').textContent = 'Tip: Click a bar (category + sentiment) to view only those reviews.';
  }
}

/* ---------- Load data & init ---------- */
fetch(DATA_URL)
  .then(r => r.json())
  .then(data => {
    RAW = (data || []).map(d => ({
      review: d.review ?? '',
      category: (d.category ?? '').toString().trim(),
      sentiment_std: d.sentiment_std ?? SENTI_MAP[d.sentiment] ?? d.sentiment ?? '',
      rating: d.rating ?? '',
      review_date: d.review_date ?? '',
      source: d.source || 'Unknown',
      app_version: d.app_version || 'Unknown'
    }));

    fillStoreSelect();
    fillVersionSelect();
    fillCategorySelect();
    refreshViews();
    document.getElementById('downloadLink').href = toCSVURI(RAW);
  })
  .catch(err => {
    console.error('Failed to load data.json', err);
    document.getElementById('summary').textContent = 'Failed to load data.json';
  });
</script>
</body>
</html>

