<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    /* ====== Base ====== */
    :root { --sidebar-w: 260px; --sidebar-bg:#ffffff; --sidebar-border:#e5e7eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; }

    /* ====== Sidebar + Toggle (inside header) ====== */
    .sidebar{
      position: fixed; inset: 0 auto 0 0; width: var(--sidebar-w); z-index: 1050;
      background: var(--sidebar-bg); border-right:1px solid var(--sidebar-border);
      transform: translateX(0); transition: transform .22s ease;
      display:flex; flex-direction:column;
    }
    .sidebar__brand{
      font-weight:700; padding:14px 16px; border-bottom:1px solid var(--sidebar-border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .sidebar-toggle-inner {
      border:none; background:transparent; font-size:20px; cursor:pointer;
      line-height:1; color:#333;
    }
    .sidebar-toggle-inner:hover { opacity:0.7; }

    .sidebar__nav{ display:flex; flex-direction:column; padding:8px; gap:4px; }
    .sidebar__nav a{
      padding:10px 12px; border-radius:8px; text-decoration:none; color:#111827;
    }
    .sidebar__nav a:hover{ background:#f3f4f6; }
    .sidebar__nav a.active{ background:#1f75fe; color:#fff; }

    .sidebar-overlay{
      position: fixed; inset:0; background:rgba(0,0,0,.35); z-index:1040;
    }

    .page{ margin-left: var(--sidebar-w); transition: margin-left .22s ease; padding:16px; }

    /* Collapsed state */
    body.sidebar-collapsed .sidebar{ transform: translateX(-100%); }
    body.sidebar-collapsed .page{ margin-left: 0; }
    body.sidebar-collapsed .sidebar-overlay{ display:none; }

    /* Responsive */
    @media (max-width: 900px){
      body:not(.sidebar-collapsed) .sidebar-overlay{ display:block; }
      .page{ margin-left: 0; } /* don‚Äôt push content on small screens */
    }

    /* ====== Page UI ====== */
    .toolbar { display:flex; align-items:center; gap:10px; margin: 8px 0 12px; flex-wrap: wrap; }
    select { min-width: 240px; padding: 6px; }
    button { padding:8px 12px; border:0; border-radius:8px; background:#f2f3f5; cursor:pointer; }
    button:hover { background:#e8e9ec; }
    a.btn { padding:8px 12px; border-radius:8px; background:#1f75fe; color:white; text-decoration:none; font-weight:600; }
    a.btn:hover { opacity:.9; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 6px 8px; border-top: 1px solid #eee; vertical-align: top; }
    th { text-align: left; }
    td.center, th.center { text-align: center; }
    #hint { color:#666; font-style: italic; }
  </style>
</head>
<body>
  <!-- Overlay (click to close on small screens) -->
  <div id="sidebarOverlay" class="sidebar-overlay" hidden></div>

  <!-- Left sliding sidebar -->
  <aside id="sidebar" class="sidebar" aria-label="Site navigation">
    <div class="sidebar__brand">
      üì± Reviews Dashboard
      <button id="sidebarToggle" class="sidebar-toggle-inner" aria-controls="sidebar" title="Toggle menu">‚ò∞</button>
    </div>
    <nav class="sidebar__nav">
      <a href="index.html">üè† Home</a>
      <a href="home.html">üåç Topic Clusters</a>
      <a class="active" href="overview.html">‚úç Topics Overview</a>
      <a href="sentiment.html">üôÇ Sentiments</a>
      <a href="review_trend.html">üìà Review Trends</a>
      <a href="rating_distribution.html">üìä Rating Distribution</a>
      <a href="avg_rating.html">‚≠ê Avg Rating by Version</a>
    </nav>
  </aside>

  <!-- Page content -->
  <div class="page">
    <h1>Overview</h1>

    <!-- Filters toolbar -->
    <div class="toolbar">
      <label for="storeSelect"><strong>Source</strong></label>
      <select id="storeSelect"></select>

      <label for="versionSelect"><strong>Version</strong></label>
      <select id="versionSelect"></select>

      <label for="categorySelect"><strong>Category</strong></label>
      <select id="categorySelect" multiple></select>

      <button id="resetBtn">Reset</button>
      <a id="downloadLink" class="btn" download="reviews_overview.csv" href="#">Download Reviews</a>
    </div>

    <div id="chart" style="height:420px;"></div>
    <h3>Reviews</h3>
    <div id="hint">Tip: Click a bar (category + sentiment). Single-click replaces; <b>Ctrl/Cmd-click</b> adds/removes. Click again to toggle.</div>
    <div id="table"></div>
  </div>

<script>
/* ====== Sidebar behavior ====== */
(function(){
  const body = document.body;
  const toggleBtn = document.getElementById('sidebarToggle');
  const overlay = document.getElementById('sidebarOverlay');
  const STORAGE_KEY = 'sidebarCollapsed';

  const saved = localStorage.getItem(STORAGE_KEY);
  const preferCollapsed = saved === 'true' || (saved === null && window.matchMedia('(max-width: 900px)').matches);
  setCollapsed(preferCollapsed);

  function setCollapsed(collapsed){
    body.classList.toggle('sidebar-collapsed', collapsed);
    toggleBtn.setAttribute('aria-expanded', String(!collapsed));
    overlay.hidden = collapsed || !window.matchMedia('(max-width: 900px)').matches;
    localStorage.setItem(STORAGE_KEY, String(collapsed));
  }

  toggleBtn.addEventListener('click', () => setCollapsed(!body.classList.contains('sidebar-collapsed')));
  overlay.addEventListener('click', () => setCollapsed(true));
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !body.classList.contains('sidebar-collapsed')) setCollapsed(true); });
  window.addEventListener('resize', () => {
    const small = window.matchMedia('(max-width: 900px)').matches;
    overlay.hidden = body.classList.contains('sidebar-collapsed') || !small;
  });
})();

/* ====== Overview page logic (no toast) ====== */
/* (same logic as before) */
const DATA_URL = 'data.json';
let RAW = [], CAT_ORDER = [], selectedGroups = [], clickedPairs = [];
const SENTI_MAP = { 'negative':'Negative','NEGATIVE':'Negative','LABEL_0':'Negative','neutral':'Neutral','NEUTRAL':'Neutral','LABEL_1':'Neutral','positive':'Positive','POSITIVE':'Positive','LABEL_2':'Positive' };
const fmtDate = s => !s ? '' : (s.length > 10 ? s.slice(0,10) : s);
const uniq = arr => Array.from(new Set(arr));

function toCSVURI(rows){ /* unchanged */ 
  if(!rows.length) return 'data:text/csv;charset=utf-8,';
  const cols=['review','category','sentiment_std','rating','review_date','source','app_version'];
  const header=cols.join(',');
  const body=rows.map(r=>cols.map(c=>{
    let v=r[c]??''; v=String(v).replace(/"/g,'""');
    if(/[",\n]/.test(v)) v=`"${v}"`; return v;
  }).join(',')).join('\n');
  return 'data:text/csv;charset=utf-8,'+[header,body].join('\n');
}

function renderTable(rows,maxRows=1000){
  const tbl=document.getElementById('table'); const hint=document.getElementById('hint');
  if(!rows.length){ tbl.innerHTML=''; hint.textContent=(clickedPairs.length||selectedGroups.length)?'No reviews match the current selection.':'Tip: Click a bar (category + sentiment) to view reviews.'; return;}
  hint.textContent=''; const slice=rows.slice(0,maxRows);
  let html=`<table><thead><tr><th>Review</th><th class="center">Sentiment</th><th class="center">Rating</th><th class="center">Date</th><th class="center">Source</th><th class="center">Version</th></tr></thead><tbody>`;
  for(const r of slice){ html+=`<tr><td>${(r.review??'').replace(/</g,'&lt;')}</td><td class="center">${r.sentiment_std??''}</td><td class="center">${r.rating??''}</td><td class="center">${fmtDate(r.review_date??'')}</td><td class="center">${r.source||'Unknown'}</td><td class="center">${r.app_version||'Unknown'}</td></tr>`;}
  html+=`</tbody></table>`; tbl.innerHTML=html;
}

function getSelectedStore(){return document.getElementById('storeSelect').value||'';}
function getSelectedVersion(){return document.getElementById('versionSelect').value||'';}
function rowsForChartScope(){let arr=RAW; const store=getSelectedStore(); if(store)arr=arr.filter(r=>(r.source||'Unknown')===store); const v=getSelectedVersion(); if(v)arr=arr.filter(r=>String(r.app_version||'Unknown')===v); return arr;}
function rowsForTable(){let arr=rowsForChartScope(); if(clickedPairs.length){const set=new Set(clickedPairs.map(p=>`${p.cat}|${p.sent}`)); return arr.filter(r=>set.has(`${r.category}|${SENTI_MAP[r.sentiment_std]||r.sentiment_std}`));} if(selectedGroups.length){const s=new Set(selectedGroups); return arr.filter(r=>s.has(r.category));} return arr;}
function syncCategorySelectFromPairs(){const sel=document.getElementById('categorySelect'); const s=new Set(clickedPairs.map(p=>p.cat)); for(const o of sel.options)o.selected=s.has(o.value);}
function applyHighlight(){const c=document.getElementById('chart'); if(!c||!c.data)return; const sents=['Positive','Neutral','Negative']; const selected=new Set(clickedPairs.map(p=>`${p.cat}|${p.sent}`)); const ops=sents.map(sent=>CAT_ORDER.map(cat=>!clickedPairs.length?1:selected.has(`${cat}|${sent}`)?1:0.15)); Plotly.restyle(c,{'marker.opacity':[ops[0],ops[1],ops[2]]});}

function drawChart(){const rows=rowsForChartScope(); CAT_ORDER=uniq(rows.map(r=>r.category).filter(Boolean)).sort();
  const b=new Map(); for(const r of rows){const c=r.category||''; const s=SENTI_MAP[r.sentiment_std||r.sentiment||'']||(r.sentiment_std||r.sentiment||''); if(!c||!s)continue; b.set(`${c}|${s}`,(b.get(`${c}|${s}`)||0)+1);}
  const yPos=CAT_ORDER.map(c=>b.get(`${c}|Positive`)||0), yNeu=CAT_ORDER.map(c=>b.get(`${c}|Neutral`)||0), yNeg=CAT_ORDER.map(c=>b.get(`${c}|Negative`)||0);
  const traces=[{name:'Positive',x:CAT_ORDER,y:yPos,type:'bar',marker:{color:'#2ca02c'}},{name:'Neutral',x:CAT_ORDER,y:yNeu,type:'bar',marker:{color:'#7f7f7f'}},{name:'Negative',x:CAT_ORDER,y:yNeg,type:'bar',marker:{color:'#d62728'}}];
  const layout={title:'Reviews by Category & Sentiment',barmode:'group',margin:{l:40,r:10,t:50,b:80},xaxis:{title:"Review Category"},yaxis:{title:"Count of Reviews"},legend:{orientation:'h',x:0,y:1.14}};
  Plotly.newPlot('chart',traces,layout,{displayModeBar:false}).then(()=>{applyHighlight(); wireClickHandler();});
}

function wireClickHandler(){const c=document.getElementById('chart'); c.removeAllListeners?.('plotly_click'); c.on('plotly_click',ev=>{const pt=ev.points?.[0]; if(!pt)return; const cat=pt.x, sent=pt.data?.name; const multi=!!(ev.event?.ctrlKey||ev.event?.metaKey); const key=`${cat}|${sent}`; const i=clickedPairs.findIndex(p=>`${p.cat}|${p.sent}`===key);
  if(multi){if(i>=0)clickedPairs.splice(i,1); else clickedPairs.push({cat,sent});}
  else{if(i>=0&&clickedPairs.length===1)clickedPairs=[]; else clickedPairs=[{cat,sent}];}
  syncCategorySelectFromPairs(); refreshViews({skipChart:true});});
}

function fillCategorySelect(){const sel=document.getElementById('categorySelect'); const cats=uniq(RAW.map(r=>r.category).filter(Boolean)).sort(); sel.innerHTML=cats.map(c=>`<option value="${c}">${c}</option>`).join(''); sel.addEventListener('change',()=>{selectedGroups=Array.from(sel.selectedOptions).map(o=>o.value); clickedPairs=[]; refreshViews({skipChart:true});});}
function fillStoreSelect(){const sel=document.getElementById('storeSelect'); const stores=['Review Source',...uniq(RAW.map(r=>r.source||'Unknown')).sort()]; sel.innerHTML=stores.map((s,i)=>`<option value="${i===0?'':s}">${s}</option>`).join(''); sel.addEventListener('change',()=>{fillVersionSelect(); clickedPairs=[]; document.getElementById('categorySelect').selectedIndex=-1; refreshViews({skipChart:false});});}
function fillVersionSelect(){const sel=document.getElementById('versionSelect'); const store=getSelectedStore(); const scope=store?RAW.filter(r=>(r.source||'Unknown')===store):RAW; const v=['All Versions',...uniq(scope.map(r=>String(r.app_version||'Unknown'))).sort()]; const cur=sel.value; sel.innerHTML=v.map((x,i)=>`<option value="${i===0?'':x}">${x}</option>`).join(''); if(v.includes(cur))sel.value=cur; sel.addEventListener('change',()=>{clickedPairs=[]; document.getElementById('categorySelect').selectedIndex=-1; refreshViews({skipChart:false});},{once:true});}
document.getElementById('resetBtn').addEventListener('click',()=>{clickedPairs=[]; selectedGroups=[]; document.getElementById('categorySelect').selectedIndex=-1; document.getElementById('storeSelect').value=''; fillVersionSelect(); document.getElementById('versionSelect').value=''; refreshViews({skipChart:false});});
function refreshViews(o={skipChart:false}){if(!o.skipChart)drawChart(); applyHighlight(); const v=rowsForTable(); renderTable(v); document.getElementById('downloadLink').href=toCSVURI(v.length?v:RAW);}

fetch(DATA_URL).then(r=>r.json()).then(d=>{RAW=(d||[]).map(x=>({review:x.review??'',category:(x.category??'').toString().trim(),sentiment_std:x.sentiment_std??SENTI_MAP[x.sentiment]??x.sentiment??'',rating:x.rating??'',review_date:x.review_date??'',source:x.source||'Unknown',app_version:x.app_version||'Unknown'}));
fillStoreSelect(); fillVersionSelect(); fillCategorySelect(); refreshViews({skipChart:false}); document.getElementById('downloadLink').href=toCSVURI(RAW);}).catch(e=>console.error('Failed to load data.json',e));
</script>
</body>
</html>
