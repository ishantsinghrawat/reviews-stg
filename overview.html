<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .toolbar { display:flex; align-items:center; gap:10px; margin: 8px 0 12px; flex-wrap: wrap; }
    select { min-width: 240px; padding: 6px; }
    button { padding:8px 12px; border:0; border-radius:8px; background:#f2f3f5; cursor:pointer; }
    button:hover { background:#e8e9ec; }
    a.btn { padding:8px 12px; border-radius:8px; background:#1f75fe; color:white; text-decoration:none; font-weight:600; }
    a.btn:hover { opacity:.9; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 6px 8px; border-top: 1px solid #eee; vertical-align: top; }
    th { text-align: left; }
    td.center, th.center { text-align: center; }
    #hint { color:#666; font-style: italic; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f5f5f7; padding:2px 6px; border-radius:6px; }

    /* --- Floating banner (toast) --- */
    .toast {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(-12px);
      min-width: 300px;
      max-width: min(92vw, 820px);
      background: #111827;   /* near-black */
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      padding: 10px 16px 14px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast--show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .toast__wrap { display:flex; flex-direction:column; gap:6px; }
    .toast__line { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .toast__pill {
      font-size: 12px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      background: #374151;
      white-space: nowrap;
    }
    .toast__pill--pos { background: #166534; }  /* green-800 */
    .toast__pill--neu { background: #4b5563; }  /* gray-600 */
    .toast__pill--neg { background: #7f1d1d; }  /* red-900 */
    .toast__text { font-size: 14px; line-height: 1.35; }
    .toast__close {
      margin-left: auto;
      background: transparent;
      border: 0;
      color: #d1d5db;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
    }
    .toast__close:hover { color: #fff; }

    /* PROGRESS BAR: smaller height (2px) */
    .toast__bar { width: 100%; height: 2px; background: #374151; border-radius: 999px; overflow: hidden; }
    .toast__bar-inner {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
      transform-origin: left center;
      transform: scaleX(1);
      transition: transform .05s linear;
    }

    /* selection chips inside toast */
    .selchip {
      background: #1f2937;
      border: 1px solid #334155;
      color: #e5e7eb;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      display:inline-flex; gap:6px; align-items:center;
    }
    .selchip b { font-weight:700; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar" style="margin-bottom:10px;">
    <a href="index.html">üè† Home</a>
    <a href="home.html">üåç Topic Clusters</a>
    <a href="overview.html"><b>‚úç Topics Overview</b></a>
    <a href="sentiment.html">üôÇ Sentiments</a>
    <a href="review_trend.html">üìà Review Trends</a>
    <a href="rating_distribution.html">üìä Rating Distribution</a>
    <a href="avg_rating.html">‚≠ê Avg Rating by Version</a>
  </div>

  <h1>Overview</h1>

  <!-- Filters toolbar -->
  <div class="toolbar">
    <label for="storeSelect"><strong>Source</strong></label>
    <select id="storeSelect"></select>

    <label for="versionSelect"><strong>Version</strong></label>
    <select id="versionSelect"></select>

    <label for="categorySelect"><strong>Category</strong></label>
    <select id="categorySelect" multiple></select>

    <button id="resetBtn">Reset</button>
    <a id="downloadLink" class="btn" download="reviews_overview.csv" href="#">Download Reviews</a>
  </div>

  <div id="summary" style="margin:8px 0 16px; color:#333;"></div>

  <div id="chart" style="height:420px;"></div>
  <h3>Reviews</h3>
  <div id="hint">Tip: Click a bar (category + sentiment). Single-click replaces; <b>Ctrl/Cmd-click</b> adds/removes. Click again to toggle.</div>
  <div id="table"></div>

  <!-- Floating banner element -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" aria-hidden="true">
    <div class="toast__wrap">
      <div class="toast__line">
        <span id="toastLabel" class="toast__pill">Selected</span>
        <div id="toastText" class="toast__text"></div>
        <button id="toastClose" class="toast__close" aria-label="Dismiss notification">√ó</button>
      </div>
      <div id="toastSelections" class="toast__line"></div>
      <div class="toast__bar"><div id="toastBar" class="toast__bar-inner"></div></div>
    </div>
  </div>

<script>
const DATA_URL = 'data.json';

let RAW = [];
let selectedGroups = [];      // dropdown multi-select
let CAT_ORDER = [];           // based on store/version scope ONLY

// Multi-bar selection: array of {cat, sent}
let clickedPairs = [];        // [{cat:'Login', sent:'Negative'}, ...]

// toast timers
let toastTimer = null;
let toastInterval = null;
const TOAST_MS = 5000;

const SENTI_MAP = { 'negative':'Negative','NEGATIVE':'Negative','LABEL_0':'Negative',
                    'neutral':'Neutral','NEUTRAL':'Neutral','LABEL_1':'Neutral',
                    'positive':'Positive','POSITIVE':'Positive','LABEL_2':'Positive' };

const fmtDate = s => !s ? '' : (s.length > 10 ? s.slice(0,10) : s);
const uniq = arr => Array.from(new Set(arr));

/* ---------- Toast helpers ---------- */
function sentimentPillText(total) {
  if (total > 1) return `${total} selections`;
  return 'Selected';
}
function showToast() {
  const el = document.getElementById('toast');
  const label = document.getElementById('toastLabel');
  const text = document.getElementById('toastText');
  const bag = document.getElementById('toastSelections');
  const bar = document.getElementById('toastBar');

  label.textContent = sentimentPillText(clickedPairs.length);
  text.innerHTML = clickedPairs.length
    ? `Showing reviews for the selections below. <span style="opacity:.8">Single-click replaces; <b>Ctrl/Cmd-click</b> adds/removes.</span>`
    : `No selection.`;

  bag.innerHTML = clickedPairs.map(({cat, sent}) =>
    `<span class="selchip"><b>${sent}</b> ‚Ä¢ ${cat}</span>`
  ).join(' ');

  el.classList.add('toast--show');
  el.setAttribute('aria-hidden', 'false');

  if (toastTimer) clearTimeout(toastTimer);
  if (toastInterval) clearInterval(toastInterval);
  bar.style.transform = 'scaleX(1)';
  const start = Date.now();

  toastInterval = setInterval(() => {
    const elapsed = Date.now() - start;
    const frac = Math.max(0, 1 - (elapsed / TOAST_MS));
    bar.style.transform = `scaleX(${frac})`;
    if (frac <= 0) clearInterval(toastInterval);
  }, 50);

  toastTimer = setTimeout(hideToast, TOAST_MS);
}
function hideToast() {
  const el = document.getElementById('toast');
  el.classList.remove('toast--show');
  el.setAttribute('aria-hidden', 'true');
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
  if (toastInterval) { clearInterval(toastInterval); toastInterval = null; }
}
document.getElementById('toastClose').addEventListener('click', hideToast);

/* ---------- CSV download ---------- */
function toCSVURI(rows) {
  if (!rows.length) return 'data:text/csv;charset=utf-8,';
  const cols = ['review','category','sentiment_std','rating','review_date','source','app_version'];
  const header = cols.join(',');
  const body = rows.map(r =>
    cols.map(c => {
      let v = r[c] ?? '';
      v = String(v).replace(/"/g, '""');
      if (/[",\n]/.test(v)) v = `"${v}"`;
      return v;
    }).join(',')
  ).join('\n');
  return 'data:text/csv;charset=utf-8,' + [header, body].join('\n');
}

/* ---------- Table ---------- */
function renderTable(rows, maxRows=1000) {
  const tbl = document.getElementById('table');
  const hint = document.getElementById('hint');
  if (!rows.length) {
    tbl.innerHTML = '';
    hint.textContent = (clickedPairs.length || selectedGroups.length)
      ? 'No reviews match the current selection.'
      : 'Tip: Click a bar (category + sentiment) to view reviews.';
    return;
  }
  hint.textContent = '';
  const slice = rows.slice(0, maxRows);
  let html = `<table>
    <thead><tr>
      <th>Review</th>
      <th class="center">Sentiment</th>
      <th class="center">Rating</th>
      <th class="center">Date</th>
      <th class="center">Source</th>
      <th class="center">Version</th>
    </tr></thead><tbody>`;
  for (const r of slice) {
    html += `<tr>
      <td>${(r.review ?? '').replace(/</g,'&lt;')}</td>
      <td class="center">${r.sentiment_std ?? ''}</td>
      <td class="center">${r.rating ?? ''}</td>
      <td class="center">${fmtDate(r.review_date ?? '')}</td>
      <td class="center">${r.source || 'Unknown'}</td>
      <td class="center">${r.app_version || 'Unknown'}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  tbl.innerHTML = html;
}

/* ---------- Store/version scope for CHART (keep full view) ---------- */
function getSelectedStore(){ return document.getElementById('storeSelect').value || ''; }
function getSelectedVersion(){ return document.getElementById('versionSelect').value || ''; }

function rowsForChartScope() {
  let arr = RAW;
  const store = getSelectedStore();
  if (store) arr = arr.filter(r => (r.source || 'Unknown') === store);
  const version = getSelectedVersion();
  if (version) arr = arr.filter(r => String(r.app_version || 'Unknown') === version);
  return arr;
}

/* ---------- TABLE rows (clickedPairs union > multi-select) ---------- */
function rowsForTable() {
  let arr = rowsForChartScope();

  if (clickedPairs.length) {
    const keyset = new Set(clickedPairs.map(p => `${p.cat}|${p.sent}`));
    return arr.filter(r => {
      const sRaw = r.sentiment_std || r.sentiment || '';
      const s = SENTI_MAP[sRaw] || sRaw;
      return keyset.has(`${r.category}|${s}`);
    });
  }

  if (selectedGroups.length) {
    const set = new Set(selectedGroups);
    return arr.filter(r => set.has(r.category));
  }
  return arr;
}

/* ---------- Highlight/dim the chart ---------- */
function applyHighlight() {
  const chart = document.getElementById('chart');
  if (!chart || !chart.data) return;

  const sentiments = ['Positive','Neutral','Negative'];
  const selectedKeys = new Set(clickedPairs.map(p => `${p.cat}|${p.sent}`));
  const opacities = sentiments.map(sent =>
    CAT_ORDER.map(cat => {
      if (!clickedPairs.length) return 1.0;                    // no dimming
      return selectedKeys.has(`${cat}|${sent}`) ? 1.0 : 0.15;  // dim others
    })
  );
  Plotly.restyle(chart, { 'marker.opacity': [opacities[0], opacities[1], opacities[2]] });
}

/* ---------- Chart (only changes on store/version) ---------- */
function drawChart() {
  const rows = rowsForChartScope();
  CAT_ORDER = uniq(rows.map(r => r.category).filter(Boolean)).sort();

  const buckets = new Map();
  for (const r of rows) {
    const c = r.category || '';
    const s = SENTI_MAP[r.sentiment_std || r.sentiment || ''] || (r.sentiment_std || r.sentiment || '');
    if (!c || !s) continue;
    buckets.set(`${c}|${s}`, (buckets.get(`${c}|${s}`) || 0) + 1);
  }

  const yPos = CAT_ORDER.map(c => buckets.get(`${c}|Positive`) || 0);
  const yNeu = CAT_ORDER.map(c => buckets.get(`${c}|Neutral`)  || 0);
  const yNeg = CAT_ORDER.map(c => buckets.get(`${c}|Negative`) || 0);

  const traces = [
    { name:'Positive', x: CAT_ORDER, y: yPos, type:'bar', marker:{ color:'#2ca02c' }, hovertemplate:'Category=%{x}<br>Positive=%{y}<extra></extra>' },
    { name:'Neutral',  x: CAT_ORDER, y: yNeu, type:'bar', marker:{ color:'#7f7f7f' }, hovertemplate:'Category=%{x}<br>Neutral=%{y}<extra></extra>' },
    { name:'Negative', x: CAT_ORDER, y: yNeg, type:'bar', marker:{ color:'#d62728' }, hovertemplate:'Category=%{x}<br>Negative=%{y}<extra></extra>' },
  ];

  const layout = {
    title: 'Reviews by Category & Sentiment',
    barmode: 'group',
    margin: {l:40,r:10,t:50,b:80},
    xaxis: { title: "Review Category" },
    yaxis: { title: "Count of Reviews" },
    legend: { orientation:'h', x:0, y:1.14 }
  };

  Plotly.newPlot('chart', traces, layout, {displayModeBar:false}).then(() => {
    applyHighlight();
    wireClickHandler();
  });
}

/* ---------- Sync Category dropdown HIGHLIGHT from bar clicks ---------- */
function syncCategorySelectFromPairs() {
  const sel = document.getElementById('categorySelect');
  const set = new Set(clickedPairs.map(p => p.cat));
  for (const opt of sel.options) {
    opt.selected = set.has(opt.value);
    // optional: auto-scroll first selected into view
    if (opt.selected && sel.selectedOptions.length === 1) {
      const optEl = opt;
      sel.scrollTop = optEl.offsetTop - 40;
    }
  }
  // Keep selectedGroups in sync only for highlighting (no filtering change here)
}

/* ---------- Click handler: multi-select with Ctrl/Cmd ---------- */
function wireClickHandler() {
  const chart = document.getElementById('chart');
  chart.removeAllListeners?.('plotly_click');
  chart.on('plotly_click', ev => {
    const pt = ev.points?.[0];
    if (!pt) return;
    const cat = pt.x;
    const sent = pt.data?.name;
    const multi = !!(ev.event?.ctrlKey || ev.event?.metaKey);

    const key = `${cat}|${sent}`;
    const idx = clickedPairs.findIndex(p => `${p.cat}|${p.sent}` === key);

    if (multi) {
      if (idx >= 0) clickedPairs.splice(idx, 1);
      else clickedPairs.push({ cat, sent });
    } else {
      if (idx >= 0 && clickedPairs.length === 1) clickedPairs = [];
      else clickedPairs = [{ cat, sent }];
    }

    if (clickedPairs.length) {
      showToast();
    } else {
      hideToast();
    }

    // HIGHLIGHT the category dropdown to reflect bar selections
    syncCategorySelectFromPairs();

    refreshViews({ skipChart: true });
  });
}

/* ---------- Selects ---------- */
function fillCategorySelect() {
  const sel = document.getElementById('categorySelect');
  const cats = uniq(RAW.map(r => r.category).filter(Boolean)).sort();
  sel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
  sel.addEventListener('change', () => {
    selectedGroups = Array.from(sel.selectedOptions).map(o => o.value);
    clickedPairs = []; // user used dropdown ‚Üí clear bar selections
    hideToast();
    refreshViews({ skipChart: true });
  });
}
function fillStoreSelect() {
  const sel = document.getElementById('storeSelect');
  const stores = ['Review Source', ...uniq(RAW.map(r => r.source || 'Unknown')).sort()];
  sel.innerHTML = stores.map((s, i) =>
    `<option value="${i===0 ? '' : s}">${s}</option>`
  ).join('');
  sel.addEventListener('change', () => {
    fillVersionSelect();
    clickedPairs = [];
    // clear highlight in category dropdown on scope change
    document.getElementById('categorySelect').selectedIndex = -1;
    hideToast();
    refreshViews({ skipChart: false });
  });
}
function fillVersionSelect() {
  const sel = document.getElementById('versionSelect');
  const store = getSelectedStore();
  const scope = store ? RAW.filter(r => (r.source || 'Unknown') === store) : RAW;
  const versions = ['All Versions', ...uniq(scope.map(r => String(r.app_version || 'Unknown'))).sort()];
  const current = sel.value;
  sel.innerHTML = versions.map((v, i) =>
    `<option value="${i===0 ? '' : v}">${v}</option>`
  ).join('');
  if (versions.includes(current)) sel.value = current;
  sel.addEventListener('change', () => {
    clickedPairs = [];
    document.getElementById('categorySelect').selectedIndex = -1;
    hideToast();
    refreshViews({ skipChart: false });
  }, { once: true });
}

/* ---------- Reset ---------- */
document.getElementById('resetBtn').addEventListener('click', () => {
  clickedPairs = [];
  selectedGroups = [];
  document.getElementById('categorySelect').selectedIndex = -1;
  document.getElementById('storeSelect').value = '';
  fillVersionSelect();
  document.getElementById('versionSelect').value = '';
  hideToast();
  refreshViews({ skipChart: false });
});

/* ---------- Sync UI ---------- */
function refreshViews(opts = { skipChart:false }) {
  if (!opts.skipChart) drawChart();  // only on store/version changes/reset
  applyHighlight();                  // dim/highlight bars
  const view = rowsForTable();       // table = union of clicked pairs, else dropdown
  renderTable(view);
  document.getElementById('downloadLink').href = toCSVURI(view.length ? view : RAW);
}

/* ---------- Init ---------- */
fetch(DATA_URL)
  .then(r => r.json())
  .then(data => {
    RAW = (data || []).map(d => ({
      review: d.review ?? '',
      category: (d.category ?? '').toString().trim(),
      sentiment_std: d.sentiment_std ?? SENTI_MAP[d.sentiment] ?? d.sentiment ?? '',
      rating: d.rating ?? '',
      review_date: d.review_date ?? '',
      source: d.source || 'Unknown',
      app_version: d.app_version || 'Unknown'
    }));

    fillStoreSelect();
    fillVersionSelect();
    fillCategorySelect();
    refreshViews({ skipChart: false });
    document.getElementById('downloadLink').href = toCSVURI(RAW);
  })
  .catch(err => {
    console.error('Failed to load data.json', err);
    document.getElementById('summary').textContent = 'Failed to load data.json';
  });
</script>
</body>
</html>
