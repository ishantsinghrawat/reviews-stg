name: Daily review analysis (Google Play) â†’ JSON + alert

on:
  schedule:
    - cron: "0 11 * * *"     # 11:00 UTC daily (07:00 Toronto during EDT)
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache Hugging Face
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-${{ hashFiles('scripts/build_reviews_json.py') }}
          restore-keys: |
            ${{ runner.os }}-hf-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build new_data.json + reviews.json (GP + iOS â†’ NLP, last 30 days)
        env:
          # Google Play
          GP_PACKAGE: com.mcdonalds.superapp
          GP_COUNTRY: ca
          GP_LANG: en
          ONLY_VERSION: ""           # optional (pins both stores if set)

          # App Store
          INCLUDE_APPSTORE: "true"
          IOS_APP_ID: "375695000"
          IOS_COUNTRY: "ca"
          IOS_LANG: "en"
          IOS_ONLY_VERSION: ""       # optional (pins only iOS if set)

          # Date window
          LAST_DAYS: "30"            # <-- pull only the last month

          # NLP labels & caches
          ZS_LABELS: "Authentication/Login,Performance/Speed,UI/UX,Crashes/Bugs,Payments,Rewards/Offers,Feature Requests,Customer Support,Location/Geolocation,Refunds,Delivery,Other"
          HF_HOME: ${{ runner.temp }}/hf_home
          TRANSFORMERS_CACHE: ${{ runner.temp }}/hf_home
          HF_HUB_DISABLE_SYMLINKS: "1"
          HF_HUB_DISABLE_TELEMETRY: 1
          TOKENIZERS_PARALLELISM: false
        run: |
          python scripts/build_reviews_json.py \
            --out-new new_data.json \
            --out-reviews reviews.json

      - name: Compare negative sentiment vs current data.json
        id: compare
        run: |
          python scripts/compare_negatives.py \
            --current data.json \
            --new new_data.json \
            --report delta_report.md \
            --threshold-abs 1 \
            --threshold-rel 0.1

      - name: Show report (always)
        if: always()
        run: |
          if [ -f delta_report.md ]; then
            echo "---- delta_report.md ----"
            cat delta_report.md
          else
            echo "No report produced."
          fi

      # # ðŸ”” EMAIL ALERT (Outlook/Office365 via SMTP) â€” only when alert == true
      # - name: Send alert email (Office365 SMTP)
      #   if: steps.compare.outputs.alert == 'true'
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: ${{ secrets.O365_SMTP_SERVER }}
      #     server_port: ${{ secrets.O365_SMTP_PORT }}
      #     secure: false                      # STARTTLS on port 587
      #     username: ${{ secrets.O365_USERNAME }}
      #     password: ${{ secrets.O365_PASSWORD }}
      #     from: ${{ secrets.ALERT_FROM }}
      #     to: ${{ secrets.ALERT_TO }}
      #     subject: "ðŸš¨ Negative sentiment increase detected â€” ${{ github.repository }} â€” run #${{ github.run_number }}"
      #     content_type: text/html
      #     attachments: delta_report.md
      #     body: |
      #       <p>Hi team,</p>
      #       <p>The daily review refresh detected an increase in <b>Negative</b> sentiment in one or more categories.</p>
      #       <p><b>Repo:</b> <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a><br/>
      #       <b>Workflow run:</b> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></p>
      #       <p>The full Markdown report is attached (<code>delta_report.md</code>).</p>

      - name: Commit updated data.json + reviews.json
        if: steps.compare.outputs.updated == 'true'
        run: |
          mv new_data.json data.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json reviews.json
          git commit -m "chore: daily Google Play refresh"
          git push

      - name: Open/Update alert issue on negative-sentiment increase
        if: steps.compare.outputs.alert == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('delta_report.md', 'utf8');
            const title = `ðŸš¨ Negative sentiment increase detected (${new Date().toISOString().slice(0,10)})`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo, state: 'open', per_page: 50
            });
            const existing = issues.find(i => i.title.startsWith('ðŸš¨ Negative sentiment increase detected'));
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: existing.number, body: report
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title, body: report
              });
            }
